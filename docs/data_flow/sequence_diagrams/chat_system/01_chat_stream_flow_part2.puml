@startuml
!define RECTANGLE class

skinparam sequence {
    ArrowColor #333333
    ArrowThickness 2
    ActorBackgroundColor #F0F0F0
    ActorBorderColor #333333
    ParticipantBackgroundColor #FFFFFF
    ParticipantBorderColor #333333
    ParticipantFontSize 12
    ParticipantFontStyle bold
    LifeLineBackgroundColor #F0F0F0
    LifeLineBorderColor #999999
    BoxPadding 10
    MessagePadding 15
}

skinparam note {
    BackgroundColor #FFFFCC
    BorderColor #999999
    FontSize 11
}

title Chat Streaming Flow - Step 2: Agent Factory & Chat Agent Initialization

' Participants
participant API as "**API**\nchat_stream.py" #FFF3E0
participant AppState as "**AppState**\nrequest.app.state" #E0F2F1
participant Factory as "**Factory**\nAgentFactory" #FFF8E1
participant Agent as "**Agent**\nArxivAugmentedEngine" #E8EAF6
participant LLM as "**LLM**\nChatGoogleGenerativeAI" #FFEBEE
participant QueryEngine as "**QueryEngine**\nRAG QueryEngine" #F3E5F5

autonumber

== Step 2: Agent Factory & Chat Agent Initialization ==

' File: chat_stream.py lines 61-66
API -> AppState: getattr(request.app.state, "agent_factory", None)
activate AppState

note right of API
    **File:** chat_stream.py lines 61-66
    **Action:** Try cached factory first
end note

alt Cached factory exists
    AppState --> API: agent_factory
else No cached factory
    API -> API: logger.warning("[STREAM] No cached factory in app.state, creating on-demand")
    
    API -> Factory: get_agent_factory(app_state)
    activate Factory
    
    note right of Factory
        **File:** factory.py lines 74-87
        **Pattern:** Singleton pattern
    end note
    
    Factory --> API: new AgentFactory
    deactivate Factory
end

deactivate AppState

' File: factory.py lines 31-47
API -> Factory: get_chat_agent()
activate Factory

note right of Factory
    **File:** factory.py lines 31-47
end note

alt Agent not initialized
    Factory -> Agent: ArxivAugmentedEngine(query_engine?)
    activate Agent
    
    note right of Agent
        **File:** research_engine.py lines 38-83
    end note
    
    ' File: research_engine.py line 51
    Agent -> Agent: Initialize ChatHistoryManager
    note right of Agent
        **File:** research_engine.py line 51
    end note
    
    ' File: research_engine.py lines 54-63
    Agent -> LLM: ChatGoogleGenerativeAI(model="gemini-2.5-flash")
    activate LLM
    
    note right of Agent
        **File:** research_engine.py lines 54-63
    end note
    
    LLM --> Agent: LLM initialized
    deactivate LLM
    
    ' File: research_engine.py lines 66-77
    Agent -> QueryEngine: QueryEngine() or use injected
    activate QueryEngine
    
    note right of Agent
        **File:** research_engine.py lines 66-77
    end note
    
    alt QueryEngine initialization succeeds
        QueryEngine --> Agent: query_engine
        deactivate QueryEngine
        
        ' File: research_engine.py line 78
        Agent -> Agent: create_rag_tool(query_engine)
        note right of Agent
            **File:** research_engine.py line 78
        end note
    else QueryEngine fails
        Agent -> Agent: Set _rag_tool = None
        note right of Agent
            **File:** research_engine.py lines 80-82
            **Mode:** Arxiv-only mode
        end note
    end
    
    Agent --> Factory: agent instance
    deactivate Agent
    
else Agent already exists
    Factory --> API: cached agent
end

Factory --> API: agent (ArxivAugmentedEngine)
deactivate Factory

' Continue to Step 3
note over API: Continue to Stream Execution...

@enduml
