@startuml
!define RECTANGLE class

skinparam sequence {
    ArrowColor Black
    LifeLineBorderColor Black
    ParticipantBorderColor Black
    ParticipantBackgroundColor White
    ActorBorderColor Black
    ActorBackgroundColor White
}

skinparam note {
    BackgroundColor LightYellow
    BorderColor Black
}

title Run Metrics Sequence Diagram

/' ============================================
   API: GET /api/runs/{runId}/metrics
   Component: ResultsVisualization.tsx (lines 30-39)
   
   Overview: Retrieves comprehensive metrics for a training run, supporting
   both centralized and federated modes. Returns training history, final metrics,
   confusion matrix, and chart data formatted for visualization.
   ============================================ '/

autonumber

/' Frontend Components '/
participant "ResultsVisualization.tsx" as RV
participant "useResultsVisualization.ts" as Hook
participant "api.ts" as API

/' Backend Components '/
participant "runs_analytics.py" as Endpoint
participant "AnalyticsFacade\nfacade.py" as Facade
participant "MetricsService\nmetrics_service.py" as Service
participant "Transformers\ntransformers.py" as Transformers
participant "RunCRUD\nrun.py" as CR
participant "Database" as DB

/' ============================================
   STEP 1: Component to API Request
   Files: ResultsVisualization.tsx (lines 30-39)
          useResultsVisualization.ts (line 45)
          api.ts (lines 120-125)
   ============================================ '/

activate RV
RV -> Hook: useResultsVisualization({config, runId})
activate Hook

note right of Hook
    Hook receives runId
    from component props
end note

Hook -> API: getRunMetrics(runId)
activate API

note right of API
    api.ts lines 120-125
    API service function
end note

API -> Endpoint: GET /api/runs/:runId/metrics
activate Endpoint

note right of Endpoint
    HTTP request to backend
end note

/' Key Code: ResultsVisualization.tsx
   // Lines 30-39
   const {
     activeResults,           // ← From getRunMetrics
     trainingHistoryData,     // ← Transformed
     confusionMatrix,         // ← Transformed
     metricsChartData,        // ← Transformed
   } = useResultsVisualization({ config, runId });
'/

/' ============================================
   STEP 2: Backend Processing
   Files: runs_analytics.py (lines 40-50)
          facade.py (lines 60-70)
          metrics_service.py (lines 80-110)
   ============================================ '/

Endpoint -> Facade: analytics.metrics.get_run_metrics(db, runId)
activate Facade

note right of Facade
    facade.py lines 60-70
    Analytics facade interface
end note

Facade -> Service: metrics_service.get_run_metrics(db, runId)
activate Service

note right of Service
    metrics_service.py
    lines 80-110
end note

Service -> Service: Check cache

alt Cache Miss
    Service -> CR: run_crud.get_with_metrics(db, runId)
    activate CR
    
    note right of CR
        CRUD layer data access
    end note
    
    CR --> Service: Run with metrics
    deactivate CR
end

/' Key Code: metrics_service.py lines 80-110
   def get_run_metrics(self, db: Session, run_id: int):
       key = cache_key("get_run_metrics", (run_id,), {})
       
       def _compute():
           run = self._run_crud.get_with_metrics(db, run_id)
           persisted_stats = self._get_persisted_stats(db, run)
           return transform_run_to_results(run, persisted_stats)
       
       return self._cache.get_or_set(key, _compute)
'/

Service --> Facade: Run metrics data

deactivate Service

Facade --> Endpoint: Results

deactivate Facade

/' ============================================
   STEP 3: Database Queries
   File: run.py (lines 45-60)
   ============================================ '/

CR -> DB: SELECT * FROM runs WHERE id = ?
activate DB
note right of DB
    runs table
    Get experiment metadata
end note
DB --> CR: Run record
deactivate DB

CR -> DB: SELECT * FROM run_metrics WHERE run_id = ?
activate DB
note right of DB
    run_metrics table
    Per-epoch metrics (centralized)
end note
DB --> CR: Metrics list
deactivate DB

CR -> DB: SELECT * FROM server_evaluations WHERE run_id = ?
activate DB
note right of DB
    server_evaluations table
    Per-round metrics (federated)
    ORDER BY round_number
end note
DB --> CR: Evaluations list
deactivate DB

note over DB
    **Database Queries:**
    
    | Table | Query | Purpose |
    |-------|-------|---------|
    | runs | SELECT * FROM runs WHERE id = ? | Get experiment metadata |
    | run_metrics | SELECT * FROM run_metrics WHERE run_id = ? | Per-epoch metrics (centralized) |
    | server_evaluations | SELECT * FROM server_evaluations WHERE run_id = ? ORDER BY round_number | Per-round metrics (federated) |
end note

/' ============================================
   STEP 4: Transform & Response
   File: transformers.py (lines 50-120)
   ============================================ '/

Service -> Transformers: transform_run_to_results(run, persisted_stats)
activate Transformers

note right of Transformers
    transformers.py
    lines 50-120
end note

Transformers -> Transformers: Check run.training_mode

alt Federated Mode
    Transformers -> Transformers: Read from run.server_evaluations
    note right of Transformers
        Use server_evaluations
        for federated runs
    end note
else Centralized Mode
    Transformers -> Transformers: Read from run.metrics
    note right of Transformers
        Use run_metrics
        for centralized runs
    end note
end

Transformers -> Transformers: Build training_history
Transformers -> Transformers: Extract final_metrics
Transformers -> Transformers: Build confusion_matrix

Transformers --> Service: ExperimentResults dict

deactivate Transformers

Service --> API: Return results

API --> Hook: RunMetricsResponse

deactivate API

Hook -> Hook: Transform props

note right of Hook
    Lines 85-120
    
    Transformations:
    - trainingHistoryData
    - confusionMatrix
    - metricsChartData
end note

/' Data Transformations:
   Source: training_history
   Transformed To: Chart format
   Component Prop: trainingHistoryData
   
   Source: confusion_matrix
   Transformed To: 2D array
   Component Prop: confusionMatrix
   
   Source: metadata
   Transformed To: Bar chart data
   Component Prop: metricsChartData
'/

Hook --> RV: activeResults + transformed

deactivate Hook

deactivate RV

/' ============================================
   Transformations Summary
   ============================================ '/

note over Hook
    **Transformations:**
    
    | Source | Transformed To | Component Prop |
    |--------|----------------|----------------|
    | training_history | Chart format | trainingHistoryData |
    | confusion_matrix | 2D array | confusionMatrix |
    | metadata | Bar chart data | metricsChartData |
end note

/' ============================================
   File References Summary
   ============================================ '/

note right
    **File Reference Summary:**
    
    | Layer | File | Key Lines | Purpose |
    |-------|------|-----------|---------|
    | Component | ResultsVisualization.tsx | 30-39 | Main results container |
    | Hook | useResultsVisualization.ts | 45, 85-120 | Data fetching & transformation |
    | API Service | api.ts | 120-125 | HTTP client methods |
    | API Endpoint | runs_analytics.py | 40-50 | API endpoint handler |
    | Analytics | facade.py | 60-70 | Analytics facade |
    | Service | metrics_service.py | 80-110 | Business logic & caching |
    | Transformer | transformers.py | 50-120 | Data transformation |
    | CRUD | run.py | 45-60 | Run data access with metrics |
    
    **Mode-Specific Data Sources:**
    - Federated: server_evaluations table (per-round metrics)
    - Centralized: run_metrics table (per-epoch metrics)
    
    **Caching Strategy:**
    - Cache key: "get_run_metrics" + run_id
    - Cache miss: Query database and transform
    - Cache hit: Return cached results
end note

@enduml