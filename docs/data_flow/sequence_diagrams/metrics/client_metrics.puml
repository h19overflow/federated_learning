@startuml
!define RECTANGLE class

skinparam sequence {
    ArrowColor Black
    LifeLineBorderColor Black
    ParticipantBorderColor Black
    ParticipantBackgroundColor White
    ActorBorderColor Black
    ActorBackgroundColor White
}

skinparam note {
    BackgroundColor LightYellow
    BorderColor Black
}

title Client Metrics Sequence Diagrm

/' ============================================
   API: GET /api/runs/{runId}/client-metrics
   Component: ResultsVisualization.tsx (lines 37, 121-127) → ClientMetricsTab.tsx
   
   Overview: Retrieves per-client metrics for federated training runs.
   Only applicable to federated mode. Returns client training histories,
   best metrics per client, and aggregated round metrics.
   ============================================ '/

autonumber

/' Frontend Components '/
participant "ResultsVisualization.tsx" as RV
participant "useResultsVisualization.ts" as Hook
participant "api.ts" as API

/' Backend Components '/
participant "runs_client_metrics.py" as Endpoint
participant "MetricsService\nmetrics_service.py" as Service
participant "RunCRUD\nrun.py" as CR1
participant "ClientCRUD\nclient.py" as CR2
participant "RunMetricCRUD\nrun_metric.py" as CR3
participant "Database" as DB

/' UI Components '/
participant "ClientMetricsTab.tsx" as Tab

/' ============================================
   STEP 1: Component to API Request
   Files: ResultsVisualization.tsx (lines 37, 121-127)
          useResultsVisualization.ts (line 60)
          api.ts (lines 138-143)
   ============================================ '/

activate RV
RV -> Hook: useResultsVisualization({config, runId})
activate Hook

note right of Hook
    Hook receives config & runId
    from component props
end note

alt Federated Mode
    Hook -> API: getClientMetrics(runId)
    activate API
    
    note right of API
        api.ts lines 138-143
        API service function
    end note
    
    API -> Endpoint: GET /api/runs/:runId/client-metrics
    activate Endpoint
    
    note right of Endpoint
        HTTP request to backend
    end note
    
else Centralized Mode
    note right of Hook
        Skip - client metrics
        not applicable to
        centralized training
    end note
end

/' Key Code: ResultsVisualization.tsx
   // Line 37
   clientMetrics,              // ← From getClientMetrics
   clientMetricsChartData,     // ← Transformed
   clientTrainingHistories,    // ← Transformed
   aggregatedRoundMetrics      // ← Transformed
   
   // Lines 121-127 - Conditional render
   {hasClientMetrics && (
     <ClientMetricsTab
       clientMetricsChartData={clientMetricsChartData}
       clientTrainingHistories={clientTrainingHistories}
       aggregatedRoundMetrics={aggregatedRoundMetrics}
       numClients={clientMetrics?.num_clients || 0}
     />
   )}
'/

/' ============================================
   STEP 2: Backend Processing
   Files: runs_client_metrics.py (lines 25-35)
          metrics_service.py (lines 180-250)
   ============================================ '/

Endpoint -> Service: analytics.metrics.get_client_metrics(db, runId)
activate Service

note right of Service
    metrics_service.py
    lines 180-250
end note

Service -> Service: Check cache

alt Cache Miss
    Service -> CR1: run_crud.get_with_metrics(db, runId)
    activate CR1
    CR1 -> DB: SELECT * FROM runs WHERE id = ?
    activate DB
    DB --> CR1: Run record
    deactivate DB
    CR1 --> Service: Run ORM
    deactivate CR1
    
    Service -> CR2: client_crud.get_clients_by_run(db, runId)
    activate CR2
    CR2 -> DB: SELECT * FROM clients WHERE run_id = ?
    activate DB
    DB --> CR2: Client records
    deactivate DB
    CR2 --> Service: List[Client]
    deactivate CR2
    
    Service -> CR3: run_metric_crud.get_by_run_grouped_by_client(db, runId)
    activate CR3
    CR3 -> DB: SELECT * FROM run_metrics
    activate DB
    note right of DB
        WHERE run_id = ?
        AND client_id IS NOT NULL
    end note
    DB --> CR3: Per-client metrics
    deactivate DB
    CR3 --> Service: Dict[client_id, metrics]
    deactivate CR3
    
    Service -> CR3: run_metric_crud.get_aggregated_metrics_by_run(db, runId)
    activate CR3
    CR3 -> DB: SELECT * FROM run_metrics
    activate DB
    note right of DB
        WHERE run_id = ?
        AND context = 'aggregated'
    end note
    DB --> CR3: Aggregated metrics
    deactivate DB
    CR3 --> Service: List[RunMetric]
    deactivate CR3
end

/' Key Code: metrics_service.py lines 180-250
   def get_client_metrics(self, db: Session, run_id: int):
       key = cache_key("get_client_metrics", (run_id,), {})
       
       def _compute():
           run = self._run_crud.get_with_metrics(db, run_id)
           clients = self._client_crud.get_clients_by_run(db, run_id)
           grouped_metrics = self._run_metric_crud.get_by_run_grouped_by_client(db, run_id)
           aggregated = self._run_metric_crud.get_aggregated_metrics_by_run(db, run_id)
           
           clients_data = []
           for client in clients:
               client_metrics = grouped_metrics.get(client.id, [])
               clients_data.append({
                   "client_id": client.id,
                   "client_identifier": client.client_identifier,
                   "training_history": self._transform_client_history(client_metrics),
                   "best_metrics": self._extract_best_metrics(client_metrics),
               })
           
           return {
               "run_id": run_id,
               "num_clients": len(clients_data),
               "clients": clients_data,
               "aggregated_metrics": self._transform_aggregated(aggregated),
           }
       
       return self._cache.get_or_set(key, _compute)
'/

Service --> Endpoint: ClientMetricsResponse

deactivate Service

Endpoint --> API: Response

deactivate Endpoint

/' ============================================
   STEP 3: Database Queries Summary
   Files: run.py, client.py, run_metric.py
   ============================================ '/

note over DB
    **Database Queries:**
    
    | Query | Table | Condition | Purpose |
    |-------|-------|-----------|---------|
    | SELECT * FROM runs WHERE id = ? | runs | id = runId | Get experiment metadata |
    | SELECT * FROM clients WHERE run_id = ? | clients | run_id = runId | Get client list |
    | SELECT * FROM run_metrics WHERE run_id = ? AND client_id IS NOT NULL | run_metrics | run_id = runId, client_id NOT NULL | Per-client metrics |
    | SELECT * FROM run_metrics WHERE run_id = ? AND context = 'aggregated' | run_metrics | run_id = runId, context = 'aggregated' | Server-aggregated metrics |
end note

/' ============================================
   STEP 4: Transform & Response
   Files: useResultsVisualization.ts (lines 155-200)
          ClientMetricsTab.tsx (lines 51-87)
   ============================================ '/

API --> Hook: ClientMetricsResponse

deactivate API

Hook -> Hook: Transform to component props

note right of Hook
    Lines 155-200
end note

Hook -> Hook: Build clientMetricsChartData

note right of Hook
    Map clients to chart format
    Extract best_metrics for each client
end note

/' Data Transformation:
   Source: clients[].best_metrics
   Transformed To: Bar chart format
   Component Prop: clientMetricsChartData
'/

Hook -> Hook: Build clientTrainingHistories

note right of Hook
    Record<string, TrainingHistoryData[]>
    Key = client_identifier
end note

/' Data Transformation:
   Source: clients[].training_history
   Transformed To: Record with history
   Component Prop: clientTrainingHistories
'/

Hook -> Hook: Build aggregatedRoundMetrics

note right of Hook
    Array of per-round metrics
    for line chart display
end note

/' Data Transformation:
   Source: aggregated_metrics
   Transformed To: Line chart format
   Component Prop: aggregatedRoundMetrics
'/

Hook --> RV: clientMetrics + transformed props

deactivate Hook

RV -> Tab: Render ClientMetricsTab
activate Tab

note right of Tab
    Lines 51-87
    
    Props received:
    - clientMetricsChartData
    - clientTrainingHistories
    - aggregatedRoundMetrics
    - numClients
end note

deactivate Tab

deactivate RV

/' ============================================
   ClientMetricsTab Rendering Summary
   ============================================ '/

note over Tab
    **ClientMetricsTab Renders:**
    
    1. Client summary cards (lines 159-167)
       - Display number of clients
       - Show summary statistics
    
    2. Performance comparison bar chart (lines 170-213)
       - Compare best metrics across clients
       - Visualize performance differences
    
    3. Per-client training history charts (lines 216-238)
       - Individual client progress over rounds
       - Loss and accuracy curves per client
    
    4. Aggregated round metrics line chart (lines 241-307)
       - Server-level aggregated metrics
       - Round-by-round progression
end note

/' ============================================
   File References Summary
   ============================================ '/

note right
    **File Reference Summary:**
    
    | Layer | File | Key Lines | Purpose |
    |-------|------|-----------|---------|
    | Component | ResultsVisualization.tsx | 37, 121-127 | Main results container |
    | Component | ClientMetricsTab.tsx | 51-87 | Client metrics display |
    | Hook | useResultsVisualization.ts | 60, 155-200 | Data fetching & transformation |
    | API Service | api.ts | 138-143 | HTTP client methods |
    | API Endpoint | runs_client_metrics.py | 25-35 | API endpoint handler |
    | Service | metrics_service.py | 180-250 | Business logic & caching |
    | CRUD | run.py | 45-60 | Run data access |
    | CRUD | client.py | 25-35 | Client data access |
    | CRUD | run_metric.py | 60-85 | Metrics data access |
    
    **Transformations:**
    | Source | Transformed To | Component Prop |
    |--------|----------------|----------------|
    | clients[].best_metrics | Bar chart format | clientMetricsChartData |
    | clients[].training_history | Record with history | clientTrainingHistories |
    | aggregated_metrics | Line chart format | aggregatedRoundMetrics |
end note

@enduml