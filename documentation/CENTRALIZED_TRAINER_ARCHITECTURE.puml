@startuml 
skinparam linetype ortho
skinparam nodesep 120
skinparam ranksep 120

package "Initialization" {
  component [CentralizedTrainer__init] as INIT
  component [ConfigManager] as CFG
  component [Logging Setup] as LOG
  component [Directory Creation] as DIRS
  component [DataSourceExtractor] as DSE
}

package "Data Source Processing" {
  component [DataSourceExtractor_extract] as EXTRACT
  component [Zip File Handler] as ZIP
  component [Directory Handler] as DIR
  component [CSV Validator] as CSV_VAL
  component [Image Validator] as IMG_VAL
}

package "Dataset Preparation" {
  component [prepare_dataset] as PREP
  component [load_metadata] as LOAD_META
  component [sample_dataframe] as SAMPLE
  component [create_train_val_split] as SPLIT
  component [Pandas DataFrame] as DF
}

package "Data Module Creation" {
  component [create_data_module] as CREATE_DM
  component [XRayDataModule] as XDM
  component [Image Transforms] as TRANSFORMS
  component [Dataset Class] as DATASET
}

package "Model and Training Setup" {
  component [build_model_callbacks] as BUILD_MODEL
  component [LitResNet Model] as LITRES
  component [Callbacks Builder] as CB_BUILDER
  component [TensorBoard Logger] as TB_LOG
  component [Checkpoint Callback] as CKPT_CB
}

package "Trainer Execution" {
  component [build_trainer] as BUILD_TRAINER
  component [PyTorch Lightning Trainer] as PL_TRAINER
  component [trainer fit] as FIT
  component [trainer test] as TEST
}

package "Results Collection" {
  component [collect_training_results] as COLLECT
  component [MetricsCollector] as MC
  component [Best Model Path] as BMP
  component [Trainer State] as TS
  component [Metrics History] as MH
}

package "Output and Logging" {
  component [Results Dictionary] as RESULTS
  component [Metrics JSON Output] as JSON_OUT
  component [Checkpoint Files] as CKPT_FILES
  component [Training Logs] as TRAIN_LOGS
}

INIT --> CFG
INIT --> LOG
INIT --> DIRS
INIT --> DSE

INIT --> EXTRACT

EXTRACT --> ZIP
EXTRACT --> DIR
EXTRACT --> CSV_VAL
EXTRACT --> IMG_VAL

EXTRACT --> PREP

PREP --> LOAD_META
PREP --> SAMPLE
PREP --> SPLIT
LOAD_META --> DF
SAMPLE --> DF
SPLIT --> DF

PREP --> CREATE_DM

CREATE_DM --> XDM
CREATE_DM --> TRANSFORMS
CREATE_DM --> DATASET
DATASET --> DF

CREATE_DM --> BUILD_MODEL

BUILD_MODEL --> LITRES
BUILD_MODEL --> CB_BUILDER
CB_BUILDER --> TB_LOG
CB_BUILDER --> CKPT_CB

BUILD_MODEL --> BUILD_TRAINER

BUILD_TRAINER --> PL_TRAINER
BUILD_TRAINER --> TB_LOG
PL_TRAINER --> FIT
PL_TRAINER --> TEST
FIT --> MC

BUILD_TRAINER --> COLLECT

COLLECT --> MC
COLLECT --> BMP
COLLECT --> TS
COLLECT --> MH
MC --> RESULTS
BMP --> RESULTS
TS --> RESULTS
MH --> RESULTS

COLLECT --> RESULTS

RESULTS --> JSON_OUT
LITRES --> CKPT_FILES
TB_LOG --> TRAIN_LOGS

@enduml
